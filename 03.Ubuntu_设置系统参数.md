## 1.系统时间

在上一篇文章 [02.Ubuntu_安装系统软件](./02.Ubuntu_安装系统软件.md) 中，已经安装了必要软件，现在开始配置系统基础参数。  

默认情况下 Ubuntu Server 的系统时间需要调整，执行以下命令将系统时区设置为中国时区。  

```bash
## 设置系统时区
$ sudo timedatectl set-timezone Asia/Shanghai

## 检查系统时间
$ date -R

#### 系统时间示例输出
Mon, 26 Jun 2023 16:16:16 +0800
```

Ubuntu Server 默认使用 `systemd-timesyncd.service` 同步时间，且需要调整为使用国内 NTP 服务器。  

调整 NTP 服务器参数，逐行执行以下命令。  

```bash
## 创建 NTP 配置文件的文件夹
$ sudo mkdir -p /etc/systemd/timesyncd.conf.d

## 创建 NTP 配置文件
$ sudo nvim /etc/systemd/timesyncd.conf.d/server_ntp.conf
```

在配置文件中添加以下配置项，并保存。  

```bash
# This configuration file is customized by fox,
# Optimize system NTP server.

[Time]
NTP=ntp.tencent.com ntp.aliyun.com

```

## 2.系统自动更新

配置 Ubuntu 服务器的系统自动更新，与配置 Debian 系统自动更新方法基本一致，参阅 [PVE 制作虚拟机模板](https://gitee.com/callmer/pve_toss_notes/blob/master/05.PVE制作虚拟机模板.md) 。  

## 3.系统内核模块

本段内核模块设置主要针对 `nftables` 的一些必要特性进行设置。  

使用 `neovim` 编辑器创建 **内核模块** 配置文件，执行以下命令。  

```bash
## 创建 内核模块 配置文件
$ sudo nvim /etc/modules-load.d/server_modules.conf
```

在配置文件中添加以下配置项，并保存。  

```bash
# This configuration file is customized by fox,
# Optimize netfilter related modules at system boot.

nf_conntrack

```

## 4.系统内核参数

为了能让服务器完成路由器功能，需要对内核参数进行调整。  

使用 `neovim` 编辑器编辑 **内核参数** 配置文件，执行以下命令。  

```bash
## 编辑 内核参数 配置文件
$ sudo nvim /etc/sysctl.d/99-sysctl.conf
```

在配置文件末尾输入以下配置项，注意配置中间的空格。  

```bash
# This configuration file is customized by fox,
# Optimize sysctl parameters for Linux Router.

kernel.panic = 20
kernel.panic_on_oops = 1

net.core.default_qdisc = fq_codel

net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1

net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# Other adjustable system parameters

net.core.rps_sock_flow_entries = 32768

net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.default.arp_ignore = 1

net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

net.ipv4.conf.all.log_martians = 1

net.ipv4.igmp_max_memberships = 100

net.ipv4.route.error_burst = 500
net.ipv4.route.error_cost = 100

net.ipv4.route.redirect_load = 2
net.ipv4.route.redirect_silence = 2048

net.ipv4.tcp_challenge_ack_limit = 1000
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 120
net.ipv4.tcp_max_orphans = 4096
net.ipv4.tcp_max_tw_buckets = 4096
net.ipv4.tcp_syncookies = 1

net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0

net.netfilter.nf_conntrack_acct = 1
net.netfilter.nf_conntrack_tcp_timeout_established = 7440
net.netfilter.nf_conntrack_udp_timeout = 60
net.netfilter.nf_conntrack_udp_timeout_stream = 180

```

保存该配置文件后，重启系统或者执行以下命令让配置生效。  

```bash
## 让内核参数生效
$ sudo sysctl -f
```

## 5.配置 ZSH

`Zsh` 是比 `Bash` 好用的 `Shell` 程序，使用 `oh-my-zsh` 进行配置。  

```bash
## 返回 home 目录
$ cd

## 使用 curl 安装 oh-my-zsh
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

## 或者使用 wget 安装 oh-my-zsh
$ sh -c "$(wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"

## 询问是否切换默认 shell，输入 Y

#### 示例输出
Time to change your default shell to zsh:
Do you want to change your default shell to zsh? [Y/n] y
```

## 6.清理系统

逐行执行以下命令，注意命令中的空格。  

```bash
## 清理系统软件包
$ sudo apt clean && sudo apt autoclean && sudo apt autoremove --purge

## 清理系统缓存
$ sudo rm -rvf /var/cache/apt/* /var/lib/apt/lists/* /tmp/*

## 清理系统日志
$ sudo find /var/log/ -type f | xargs sudo rm -rvf

## 清理命令历史记录文件
$ rm -rvf ~/.bash_history ~/.zsh_history

## 清理命令历史
$ history -c

## 关闭系统
$ sudo shutdown now
```

## 7.虚拟机硬件参数

在 Ubuntu Server 关机后，进入 PVE 的 WEB 管理界面，移除其光驱设备。  

![PVE移除光驱](img/p03/u_pve_remove_iso.jpeg)

再次检查系统引导项，确保只有 `scsi0` 作为引导项。  

![PVE检查引导顺序](img/p03/u_pve_check_booting_order.jpeg)

## 8.备份虚拟机

由于后续对 Ubuntu Server 的配置较多，建议分阶段对虚拟机进行备份操作。  

这样，在意外配置错误或虚拟机异常等情况下，能快速将虚拟机回滚到正常状态。  

![PVE备份虚拟机](img/p03/u_pve_backup_vm.jpeg)

至此，Ubuntu 服务器设置系统参数步骤完成。  
